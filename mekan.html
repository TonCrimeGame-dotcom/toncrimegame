<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TonCrime - Mekan</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="game-core.js"></script>

<style>
body{
  margin:0;
  background:#111414;
  color:white;
  font-family:Arial;
}

.topbar{
  background:#1d2424;
  padding:18px 40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.right-stats{ width:420px; }

.bar{
  width:100%;
  height:8px;
  background:#333;
  border-radius:5px;
  overflow:hidden;
  margin-bottom:6px;
}

.fill{ height:100%; }
.xp{ background:#00ff99; }
.energy{ background:#ffaa00; }

.main{
  padding:60px;
  display:flex;
  justify-content:center;
}

.card{
  width:450px;
  background:#1d2424;
  padding:30px;
  border-radius:12px;
  text-align:center;
  border:1px solid #2f3a3a;
}

button{
  width:100%;
  padding:14px;
  margin-top:15px;
  background:#00ff99;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}

button:hover{ opacity:0.85; }

.info{
  margin-top:15px;
  font-size:14px;
  color:#ccc;
}
</style>
</head>
<body>

<div class="topbar">
  <div><b>üè¢ Mekan ƒ∞≈ületmesi</b></div>

  <div class="right-stats">
    <div id="stats"></div>

    <div class="bar">
      <div id="xpBar" class="fill xp"></div>
    </div>

    <div class="bar">
      <div id="energyBar" class="fill energy"></div>
    </div>
  </div>
</div>

<div class="main">
  <div class="card">
    <h2>Pasif √úretim</h2>

    G√ºnl√ºk √ºretim: 50 Yton<br>
    Stok limiti: 500 Yton<br>

    <div class="info" id="stockInfo"></div>

    <button onclick="collectIncome()">Geliri Topla</button>
  </div>
</div>

<script>

const DAILY_PRODUCTION = 50;
const STOCK_LIMIT = 500;
const DAY_MS = 24 * 60 * 60 * 1000;

/* ===== √úRETƒ∞M HESAPLAMA ===== */
async function calculateProduction(user){

  let now = Date.now();

  if(!user.last_production){
    await db.from("users").update({
      last_production: now,
      stock: 0
    }).eq("id", user.id);

    user.last_production = now;
    user.stock = 0;
  }

  let diff = now - user.last_production;
  let days = Math.floor(diff / DAY_MS);

  if(days > 0){

    let newStock = Math.min(
      STOCK_LIMIT,
      (user.stock || 0) + (days * DAILY_PRODUCTION)
    );

    let newTime = user.last_production + (days * DAY_MS);

    await db.from("users").update({
      stock: newStock,
      last_production: newTime
    }).eq("id", user.id);

    user.stock = newStock;
    user.last_production = newTime;
  }

  return user;
}

/* ===== GELƒ∞R TOPLAMA ===== */
async function collectIncome(){

  let user = await loadUser();
  if(!user) return;

  user = await calculateProduction(user);

  if(!user.stock || user.stock <= 0){
    alert("Toplanacak gelir yok.");
    return;
  }

  let amount = user.stock;

  await updateUser({
    yton: amount,
    xp: 10
  });

  await db.from("users").update({
    stock: 0
  }).eq("id", user.id);

  alert(amount + " Yton toplandƒ±! +10 XP");

  render();
}

/* ===== RENDER ===== */
async function render(){

  let user = await loadUser();
  if(!user) return;

  user = await regenEnergy(user);
  user = await calculateProduction(user);

  renderStats(user);

  document.getElementById("stockInfo").innerHTML =
    "Mevcut stok: " + (user.stock || 0) + " Yton";
}

render();
setInterval(render,5000);

</script>

</body>
</html>
