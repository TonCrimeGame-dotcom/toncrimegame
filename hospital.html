<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TonCrime - Hastane</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="game-core.js"></script>

<style>
body{
  margin:0;
  background:#0e1a1f;
  color:white;
  font-family:Arial;
}

/* TOPBAR */
.topbar{
  background:#12303a;
  padding:18px 40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.right-stats{ width:420px; }

.bar{
  width:100%;
  height:8px;
  background:#333;
  border-radius:5px;
  overflow:hidden;
  margin-bottom:6px;
}

.fill{ height:100%; }
.xp{ background:#00bfff; }
.energy{ background:#00ffcc; }

/* MAIN */
.main{
  padding:60px;
  display:flex;
  justify-content:center;
}

.card{
  width:420px;
  background:#12303a;
  padding:30px;
  border-radius:12px;
  text-align:center;
  border:1px solid #1e5566;
}

button{
  width:100%;
  padding:14px;
  margin-top:15px;
  background:#00bfff;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}

button:hover{ opacity:0.85; }

.timer{
  margin-top:15px;
  font-size:14px;
  color:#ccc;
}
</style>
</head>
<body>

<div class="topbar">
  <div><b>üè• Hastane</b></div>

  <div class="right-stats">
    <div id="stats"></div>

    <div class="bar">
      <div id="xpBar" class="fill xp"></div>
    </div>

    <div class="bar">
      <div id="energyBar" class="fill energy"></div>
    </div>
  </div>
</div>

<div class="main">
  <div class="card">
    <h2>Enerji Tedavisi</h2>
    1 Enerji = 2 Yton<br>

    <button onclick="buyEnergy(5)">5 Enerji (10 Yton)</button>
    <button onclick="buyEnergy(10)">10 Enerji (20 Yton)</button>
    <button onclick="buyEnergy(20)">20 Enerji (40 Yton)</button>

    <div class="timer" id="hospitalTimer"></div>
  </div>
</div>

<script>

const HOSPITAL_WAIT = 2 * 60 * 60 * 1000; // 2 saat

/* ===== ENERJI SATIN AL ===== */
async function buyEnergy(amount){

  let user = await loadUser();
  if(!user) return;

  user = await regenEnergy(user);

  const cost = amount * 2;

  if(user.yton < cost){
    alert("Yetersiz Yton!");
    return;
  }

  await updateUser({
    yton: -cost,
    energy: amount
  });

  alert(amount + " enerji satƒ±n alƒ±ndƒ±!");

  render();
}

/* ===== HASTANE BEKLEME Sƒ∞STEMƒ∞ ===== */
async function checkHospital(){

  let user = await loadUser();
  if(!user) return;

  if(!user.hospital_until){
    document.getElementById("hospitalTimer").innerText = "";
    return;
  }

  let now = Date.now();

  if(now >= user.hospital_until){

    await db.from("users").update({
      hospital_until: null
    }).eq("id", user.id);

    document.getElementById("hospitalTimer").innerText =
      "ƒ∞yile≈ütin! Tekrar oyundasƒ±n.";
    return;
  }

  let remaining = user.hospital_until - now;
  let hours = Math.floor(remaining / 3600000);
  let minutes = Math.floor((remaining % 3600000) / 60000);

  document.getElementById("hospitalTimer").innerText =
    "ƒ∞yile≈üme s√ºresi: " + hours + "s " + minutes + "dk";
}

/* ===== RENDER ===== */
async function render(){

  let user = await loadUser();
  if(!user) return;

  user = await regenEnergy(user);

  renderStats(user);

  checkHospital();
}

render();
setInterval(render,3000);

</script>

</body>
</html>
