<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TonCrime - PvP</title>

  <link rel="stylesheet" href="css/global.css" />

  <!-- Bu sayfaya özel küçük düzeltme CSS'leri (menü yok, leaderboard kesilmez) -->
  <style>
    /* Menü asla görünmesin (yanlışlıkla inject edilse bile) */
    .sidebar, .overlay, .menu-wrapper, .menu-slider, .menu-card { display:none !important; }

    /* Geri butonu */
    .back-btn{
      position:absolute;
      top:14px;
      left:14px;
      z-index:50;
      padding:8px 12px;
      border-radius:12px;
      border:1px solid rgba(255,215,0,0.75);
      background:rgba(0,0,0,0.35);
      color:gold;
      font-weight:700;
      cursor:pointer;
      user-select:none;
      backdrop-filter: blur(6px);
    }
    .back-btn:active{ transform: scale(0.98); }

    /* PvP kartı - ortada */
    .pvp-card{
      position:absolute;
      left:50%;
      top:52%;
      transform:translate(-50%,-50%);
      width:340px;
      border-radius:18px;
      padding:14px;
      background:rgba(0,0,0,0.40);
      color:#fff;
      z-index:30;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }
    .pvp-title{
      text-align:center;
      color:gold;
      font-weight:800;
      letter-spacing:.5px;
      margin-bottom:10px;
    }
    .pvp-row{
      display:flex;
      justify-content:space-between;
      opacity:.9;
      font-size:12px;
      margin-bottom:10px;
    }

    .pvp-players{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin:8px 0 10px;
    }
    .pvp-side{
      flex:1;
      background:rgba(255,255,255,0.06);
      border-radius:14px;
      padding:10px;
    }
    .pvp-name{ font-weight:800; color:gold; font-size:13px; }
    .pvp-mini{ font-size:11px; opacity:.85; margin-top:6px; }
    .pvp-hptext{ font-size:11px; opacity:.9; margin-top:6px; }

    .pvp-vs{
      width:34px;
      text-align:center;
      font-weight:900;
      color:gold;
      padding-top:18px;
      opacity:.9;
    }

    .pvp-bar{
      height:8px;
      background:rgba(255,255,255,0.12);
      border-radius:999px;
      overflow:hidden;
      margin-top:6px;
    }
    .pvp-fill{
      height:100%;
      width:0%;
      background:rgba(0,255,150,0.85);
    }

    .pvp-actions{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .pvp-btn{
      flex:1;
      border:none;
      border-radius:12px;
      padding:10px 10px;
      font-weight:800;
      cursor:pointer;
      background:gold;
      color:#151515;
    }
    .pvp-btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .pvp-btn.ghost{
      background:rgba(255,255,255,0.12);
      color:#fff;
      border:1px solid rgba(255,215,0,0.45);
    }

    .pvp-log{
      margin-top:10px;
      max-height:90px;
      overflow:auto;
      font-size:11px;
      line-height:1.35;
      opacity:.95;
      padding-right:6px;
    }

    /* Leaderboard - altta TAM görünür (kesilmez) */
    .pvp-leaderboard{
      position:absolute;
      left:50%;
      bottom:14px;
      transform:translateX(-50%);
      width:360px;
      border-radius:16px;
      background:rgba(0,0,0,0.35);
      z-index:20;
      padding:10px 10px 12px;
      backdrop-filter: blur(8px);
    }
    .lb-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      color:gold;
      font-weight:800;
      font-size:12px;
    }
    .lb-me{ color:#fff; opacity:.85; font-weight:700; font-size:11px; }
    .lb-list{
      max-height:120px;          /* kesilmesin */
      overflow:auto;
      padding-right:6px;
    }
    .lb-item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      border-radius:12px;
      background:rgba(255,255,255,0.06);
      margin-bottom:6px;
      font-size:12px;
    }
    .lb-left{ display:flex; gap:8px; align-items:center; }
    .lb-rank{ color:gold; font-weight:900; width:22px; }
    .lb-name{ color:#fff; font-weight:700; }
    .lb-elo{ color:#fff; opacity:.9; font-weight:800; }

    /* Not: Hud / logo / saat motorlardan geliyor */
  </style>
</head>
<body>

  <div class="app">
    <img class="bg" src="assets/background.jpg" alt="bg">

    <!-- SADECE GERİ -->
    <div class="back-btn" id="backBtn">← Geri</div>

    <!-- PVP -->
    <div class="pvp-card" id="pvpCard">
      <div class="pvp-title">PvP Arena</div>

      <div class="pvp-row">
        <div>Durum</div>
        <div id="pvpStatus">Hazır</div>
      </div>

      <div class="pvp-players">
        <div class="pvp-side">
          <div class="pvp-name" id="meName">Sen</div>
          <div class="pvp-hptext" id="meHpText">HP: 100/100</div>
          <div class="pvp-bar"><div class="pvp-fill" id="meHpBar"></div></div>
          <div class="pvp-mini" id="meStats">ATK: 10 • Bonus: +0%</div>
        </div>

        <div class="pvp-vs">VS</div>

        <div class="pvp-side">
          <div class="pvp-name" id="opName">Rakip</div>
          <div class="pvp-hptext" id="opHpText">HP: -</div>
          <div class="pvp-bar"><div class="pvp-fill" id="opHpBar"></div></div>
          <div class="pvp-mini" id="opStats">ATK: -</div>
        </div>
      </div>

      <div class="pvp-actions">
        <button class="pvp-btn" id="findBtn">Rakip Ara</button>
        <button class="pvp-btn" id="startBtn" disabled>Savaş Başlat</button>
        <button class="pvp-btn ghost" id="resetBtn">Sıfırla</button>
      </div>

      <div class="pvp-log" id="pvpLog"></div>
    </div>

    <!-- Leaderboard -->
    <div class="pvp-leaderboard" id="pvpLeaderboard">
      <div class="lb-head">
        <div class="lb-title">Leaderboard</div>
        <div class="lb-me" id="lbMe">ELO: - • W/L: - • Streak: -</div>
      </div>
      <div class="lb-list" id="lbList"></div>
    </div>

  </div>

  <!-- MOTORLAR -->
  <script src="js/player.engine.js"></script>
  <script src="js/chat.engine.js"></script>
  <!-- menu.js KESİNLİKLE YOK -->

  <!-- PvP: tek parça, player oluşturmadan window.player kullanır -->
  <script>
    // ✅ İSTEDİĞİN GİBİ: player tanımı yok, sadece referans
    const player = window.player;

    // Güvenlik: motor yüklenmeden açılırsa sayfa bozulmasın
    if (!player) {
      console.warn("player.engine.js yüklenmedi veya window.player yok.");
    }

    const $ = (id) => document.getElementById(id);

    const state = {
      me: { hp: 100, hpMax: 100, atk: 10, bonus: 0 },
      op: null,
      searching: false,
      inFight: false,
      t: null
    };

    function logLine(txt){
      const box = $("pvpLog");
      const div = document.createElement("div");
      div.textContent = txt;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    function setBar(barId, textId, cur, max){
      const pct = max ? clamp((cur/max)*100, 0, 100) : 0;
      $(barId).style.width = pct + "%";
      $(textId).textContent = "HP: " + cur + "/" + max;
    }

    function syncMeFromPlayer(){
      // isim / bonus / saldırı gücü (silah bonusu)
      const name = player?.name || "Player01";
      const weaponName = player?.weapon?.name || "Tabanca";
      const weaponBonus = Number(player?.weapon?.bonus || 0); // 0.10 => %10
      const bonusPct = Math.round(weaponBonus * 100);

      // Basit ATK: 10 + level etkisi + bonus
      const lvl = Number(player?.level || 1);
      const baseAtk = 10 + Math.floor(lvl/5);
      const atk = Math.round(baseAtk * (1 + weaponBonus));

      state.me.atk = atk;
      state.me.bonus = bonusPct;

      $("meName").textContent = name;
      $("meStats").textContent = `ATK: ${atk} • Bonus: +${bonusPct}% • ${weaponName}`;
      setBar("meHpBar","meHpText", state.me.hp, state.me.hpMax);
    }

    function setOpponent(op){
      state.op = op;
      $("opName").textContent = op.name;
      $("opStats").textContent = `ATK: ${op.atk} • Bonus: +${op.bonus}%`;
      setBar("opHpBar","opHpText", op.hp, op.hpMax);
    }

    function randomOpponent(){
      const names = ["Shadow", "Viper", "Razor", "Ghost", "Nova", "Reaper"];
      const n = names[Math.floor(Math.random()*names.length)] + "#" + Math.floor(100 + Math.random()*900);
      const atk = 9 + Math.floor(Math.random()*6);
      const bonus = [0, 5, 10, 15][Math.floor(Math.random()*4)];
      return { name: n, hp: 100, hpMax: 100, atk, bonus };
    }

    function renderLeaderboard(){
      // Eğer pvp.rank.engine.js yoksa bile demo leaderboard göster
      const list = $("lbList");
      list.innerHTML = "";

      const demo = [
        { name:"Shadow", elo:1120 },
        { name:"Viper", elo:1098 },
        { name:"Razor", elo:1040 },
        { name:"Ghost", elo:1010 }
      ];

      demo.forEach((p,i)=>{
        const row = document.createElement("div");
        row.className = "lb-item";
        row.innerHTML = `
          <div class="lb-left">
            <div class="lb-rank">#${i+1}</div>
            <div class="lb-name">${p.name}</div>
          </div>
          <div class="lb-elo">${p.elo}</div>
        `;
        list.appendChild(row);
      });

      // player stats (basit)
      const elo = Number(player?.elo || 1000);
      const w = Number(player?.pvpWins || 0);
      const l = Number(player?.pvpLosses || 0);
      const s = Number(player?.pvpStreak || 0);
      $("lbMe").textContent = `ELO: ${elo} • W/L: ${w}/${l} • Streak: ${s}`;
    }

    function setStatus(txt){
      $("pvpStatus").textContent = txt;
    }

    function setButtons(){
      $("findBtn").disabled = state.searching || state.inFight;
      $("startBtn").disabled = !state.op || state.searching || state.inFight;
    }

    function stopFight(){
      if (state.t) clearInterval(state.t);
      state.t = null;
      state.inFight = false;
      setButtons();
    }

    function savePlayerPvp(){
      // player.engine.js zaten localStorage yönetiyor olabilir.
      // Biz sadece window.player üstünden değerleri güncelleyip localStorage'a yazıyoruz.
      try{
        localStorage.setItem("player", JSON.stringify(player));
      }catch(e){}
    }

    function applyResult(win){
      const elo = Number(player.elo || 1000);
      const delta = win ? 18 : -12;
      player.elo = elo + delta;

      player.pvpWins = Number(player.pvpWins || 0) + (win ? 1 : 0);
      player.pvpLosses = Number(player.pvpLosses || 0) + (win ? 0 : 1);

      const streak = Number(player.pvpStreak || 0);
      player.pvpStreak = win ? (streak + 1) : 0;

      // XP ödülü
      player.xp = Number(player.xp || 0) + (win ? 60 : 20);

      savePlayerPvp();
      renderLeaderboard();
    }

    function startFight(){
      if (!state.op) return;

      setStatus("Savaş başladı");
      state.inFight = true;
      setButtons();
      logLine("Savaş başladı!");

      // Basit tur sistemi: her 900ms bir karşılıklı vuruş
      state.t = setInterval(()=>{
        // SEN vur
        state.op.hp = clamp(state.op.hp - state.me.atk, 0, state.op.hpMax);
        setBar("opHpBar","opHpText", state.op.hp, state.op.hpMax);
        logLine(`Sen vurdun: -${state.me.atk} HP`);

        if (state.op.hp <= 0){
          logLine("✅ Kazandın!");
          setStatus("Kazandın");
          stopFight();
          applyResult(true);
          return;
        }

        // RAKİP vur
        const dmg = state.op.atk;
        state.me.hp = clamp(state.me.hp - dmg, 0, state.me.hpMax);
        setBar("meHpBar","meHpText", state.me.hp, state.me.hpMax);
        logLine(`Rakip vurdu: -${dmg} HP`);

        if (state.me.hp <= 0){
          logLine("❌ Kaybettin!");
          setStatus("Kaybettin");
          stopFight();
          applyResult(false);
        }
      }, 900);
    }

    function findOpponent(){
      state.searching = true;
      setStatus("Rakip aranıyor...");
      setButtons();
      logLine("Rakip aranıyor...");

      // küçük bekleme efekti
      setTimeout(()=>{
        state.searching = false;
        const op = randomOpponent();
        setOpponent(op);
        setStatus("Rakip bulundu");
        logLine("Rakip bulundu: " + op.name);
        setButtons();
      }, 900);
    }

    function resetAll(){
      stopFight();
      state.searching = false;
      state.op = null;
      state.me.hp = state.me.hpMax;
      $("pvpLog").innerHTML = "";
      $("opName").textContent = "Rakip";
      $("opStats").textContent = "ATK: -";
      $("opHpText").textContent = "HP: -";
      $("opHpBar").style.width = "0%";
      setStatus("Hazır");
      syncMeFromPlayer();
      setButtons();
    }

    // INIT
    document.addEventListener("DOMContentLoaded", ()=>{
      $("backBtn").addEventListener("click", ()=>{
        // history yoksa ana sayfa
        if (history.length > 1) history.back();
        else location.href = "index.html";
      });

      syncMeFromPlayer();
      renderLeaderboard();
      setButtons();

      $("findBtn").addEventListener("click", findOpponent);
      $("startBtn").addEventListener("click", startFight);
      $("resetBtn").addEventListener("click", resetAll);
    });
  </script>

</body>
</html>
