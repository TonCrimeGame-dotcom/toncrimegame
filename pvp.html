<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TonCrime PvP</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{margin:0;background:#111;color:white;font-family:Arial;text-align:center}
.topbar{background:#000;padding:15px;font-size:18px}
button{padding:10px 20px;margin:8px;border:none;background:gold;font-weight:bold;cursor:pointer}
#pvpArea{margin-top:40px}
</style>
</head>
<body>

<div class="topbar">
⚔ TONCRIME PvP
</div>

<div>
<button onclick="startMatch(2.5,4)">Bronze (2.5 → 4)</button>
<button onclick="startMatch(6,10)">Silver (6 → 10)</button>
<button onclick="startMatch(0,1)">Free</button>
</div>

<div id="pvpArea"></div>

<script>

const SUPABASE_URL="https://hwhscuyudwphnsipibpy.supabase.co";
const SUPABASE_KEY="sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu";
const db=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const FUNCTION_URL="https://hwhscuyudwphnsipibpy.supabase.co/functions/v1/resolve-pvp";

let currentMatch=null;
let questions=[];
let questionIndex=0;
let totalTime=0;
let questionStart=0;

/* DEVICE ID */
if(!localStorage.getItem("device_id")){
  localStorage.setItem("device_id",crypto.randomUUID());
}

/* USER */
async function loadUser(){
  const id=localStorage.getItem("tc_user");
  if(!id){alert("Login yok");return null;}
  const {data}=await db.from("users").select("*").eq("id",id).single();
  return data;
}

/* HASH */
async function generateHash(score,time,secret){
  const data=new TextEncoder().encode(score+"-"+time+"-"+secret);
  const hashBuffer=await crypto.subtle.digest("SHA-256",data);
  const hashArray=Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* MATCH START */
async function startMatch(cost,reward){

  const user=await loadUser();
  if(!user)return;

  if(user.yton<cost){
    alert("Yetersiz Yton");
    return;
  }

  if(cost>0){
    await db.from("users").update({
      yton:user.yton-cost
    }).eq("id",user.id);
  }

  const secret=crypto.randomUUID();

  const {data}=await db.from("pvp_matches").insert({
    player1:user.id,
    status:"active",
    reward:reward,
    secret:secret
  }).select().single();

  currentMatch=data;

  questions=[
    {q:"5x5?",a:"25",o:["20","25","30","15"]},
    {q:"HTML ne?",a:"Web",o:["Web","Oyun","Virüs","Telefon"]},
    {q:"3^3?",a:"27",o:["9","27","18","81"]},
    {q:"Başkent?",a:"Ankara",o:["İzmir","Bursa","Ankara","Van"]},
    {q:"10/2?",a:"5",o:["2","5","8","6"]}
  ];

  questionIndex=0;
  totalTime=0;

  showQuestion();
}

/* QUESTION */
function showQuestion(){

  if(questionIndex>=questions.length){
    finishMatch();
    return;
  }

  const q=questions[questionIndex];
  document.getElementById("pvpArea").innerHTML=
  "<h2>"+q.q+"</h2>"+
  q.o.map(opt=>
    "<button onclick=\"answer('"+opt+"')\">"+opt+"</button>"
  ).join("<br><br>");

  questionStart=performance.now();
}

/* ANSWER */
function answer(opt){

  const q=questions[questionIndex];
  const rawTime=performance.now()-questionStart;

  if(rawTime<150){
    alert("Hız hilesi tespit edildi");
    location.reload();
    return;
  }

  totalTime+=rawTime;

  if(opt===q.a){
    currentMatch.score=(currentMatch.score||0)+1;
  }

  questionIndex++;
  showQuestion();
}

/* FINISH */
async function finishMatch(){

  const user=await loadUser();
  const hash=await generateHash(
    currentMatch.score||0,
    Math.floor(totalTime),
    currentMatch.secret
  );

  await fetch(FUNCTION_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      matchId:currentMatch.id,
      userId:user.id,
      score:currentMatch.score||0,
      time:Math.floor(totalTime),
      hash:hash,
      deviceId:localStorage.getItem("device_id")
    })
  });

  document.getElementById("pvpArea").innerHTML=
  "<h2>Maç sonucu server’a gönderildi.</h2>";
}

</script>
</body>
</html>
