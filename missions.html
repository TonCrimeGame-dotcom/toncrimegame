<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TonCrime - Görevler</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="game-core.js"></script>
</head>
<body>

<div id="stats"></div>
<div style="width:300px;height:8px;background:#333">
<div id="xpBar" style="height:8px;background:limegreen"></div>
</div>
<div style="width:300px;height:8px;background:#333;margin-top:5px">
<div id="energyBar" style="height:8px;background:gold"></div>
</div>

<div id="missions"></div>

<script>

async function render(){

  let user=await loadUser();
  if(!user) return;

  user=await regenEnergy(user);
  renderStats(user);

  const {data:missions}=await db.from("missions").select("*");

  let html="";
  missions.forEach(m=>{
    html+=`
    <div style="border:1px solid #444;padding:10px;margin:10px">
      <b>${m.name}</b><br>
      Enerji: ${m.energy_cost}<br>
      XP: ${m.xp_reward}<br>
      Yton: ${m.yton_reward}<br>
      <button onclick="startMission(${m.id})">Başlat</button>
    </div>
    `;
  });

  document.getElementById("missions").innerHTML=html;
}

async function startMission(id){

  const user=await loadUser();
  if(!user) return;

  const {data:mission}=await db.from("missions")
  .select("*")
  .eq("id",id)
  .single();

  if(user.energy<mission.energy_cost){
    alert("Yetersiz enerji");
    return;
  }

  await updateUser({
    energy:-mission.energy_cost,
    xp:mission.xp_reward,
    yton:mission.yton_reward
  });

  render();
}

render();
setInterval(render,3000);

</script>

</body>
</html>
