<script>
const SUPABASE_URL = "https://hwhscuyudwphnsipibpy.supabase.co";
const SUPABASE_KEY = "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu";

const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const userId = 591676206;

async function loadUser(){
let { data } = await db.from("users").select("*").eq("id",userId).single();
return data;
}

async function loadMissions(){
let { data } = await db.from("missions").select("*");
return data;
}

async function render(){
let user = await loadUser();
let missions = await loadMissions();

document.getElementById("stats").innerHTML =
`Lv ${user.level} | XP ${user.xp}/100 | âš¡ ${user.energy}/100 | ğŸ’° ${user.yton}`;

let html = "";

missions.forEach(m=>{
html += `
<div class="card">
<b>${m.name}</b><br>
Enerji: ${m.energy_cost}<br>
XP: ${m.xp_reward}<br>
KazanÃ§: ${m.yton_reward} Yton<br>
BaÅŸarÄ±: %${m.success_rate}
<button onclick="startMission(${m.id})">BaÅŸlat</button>
</div>
`;
});

document.getElementById("missions").innerHTML = html;
}

async function startMission(missionId){

let user = await loadUser();
let { data: mission } = await db.from("missions").select("*").eq("id",missionId).single();

if(user.energy < mission.energy_cost){
alert("Yetersiz enerji");
return;
}

let success = Math.random()*100 < mission.success_rate;

let newEnergy = user.energy - mission.energy_cost;
let newXp = user.xp;
let newYton = Number(user.yton);
let newLevel = user.level;

if(success){
newXp += mission.xp_reward;
newYton += Number(mission.yton_reward);

if(newXp >= 100){
newLevel++;
newXp -= 100;
}

alert("BaÅŸarÄ±lÄ±!");
}else{
alert("BaÅŸarÄ±sÄ±z!");
}

const { error } = await db.from("users").update({
energy: newEnergy,
xp: newXp,
yton: newYton,
level: newLevel
}).eq("id",userId);

if(error){
console.log(error);
alert("Update HatasÄ±!");
}

render();
}

render();
</script>
