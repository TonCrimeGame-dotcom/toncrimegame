<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TonCrime - Missions</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

<style>
body{margin:0;background:#0e0e0e;font-family:Arial;color:white}
.topbar{
background:#111;
padding:12px;
display:flex;
justify-content:space-between;
align-items:center;
font-weight:bold;
position:fixed;
width:100%;
top:0;
border-bottom:1px solid #222;
}
.logo{color:#ffb300;font-size:20px}
.container{padding-top:70px}
.card{
background:#1a1a1a;
margin:15px;
padding:15px;
border-radius:10px;
}
button{
background:#ffb300;
border:none;
padding:10px;
width:100%;
margin-top:10px;
font-weight:bold;
border-radius:6px;
cursor:pointer;
}
</style>
</head>
<body>

<div class="topbar">
<div class="logo">TonCrime</div>
<div id="stats">YÃ¼kleniyor...</div>
</div>

<div class="container">
<div id="playerInfo" class="card"></div>
<div id="missions"></div>
</div>

<script>

const supabase = supabase.createClient(
"https://hwhscuyudwphnsipibpy.supabase.co",
"sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

let userId = 591676206;

function xpNeeded(level){
return Math.floor(100 * Math.pow(1.05, level-1));
}

async function getUser(){
const { data } = await supabase
.from("users")
.select("*")
.eq("id", userId)
.single();
return data;
}

async function renderUser(){
let user = await getUser();
if(!user) return;

let needed = xpNeeded(user.level);

document.getElementById("stats").innerHTML =
`Lv ${user.level} | XP ${user.xp}/${needed} | âš¡ ${user.energy}/100 | ðŸ’° ${user.yton}`;

document.getElementById("playerInfo").innerHTML = `
ID: ${user.id}<br>
Takma Ad: ${user.nickname}<br>
Level: ${user.level}<br>
XP: ${user.xp}/${needed}
`;
}

async function loadMissions(){
const { data } = await supabase.from("missions").select("*");

let html="";
data.forEach(m=>{
html+=`
<div class="card">
<b>${m.name}</b><br>
Enerji: ${m.energy_cost}<br>
XP: ${m.xp_reward}<br>
KazanÃ§: ${m.yton_reward} YTon<br>
BaÅŸarÄ±: %${m.success_rate}
<button onclick="startMission(${m.id})">BaÅŸlat</button>
</div>`;
});
document.getElementById("missions").innerHTML=html;
}

async function startMission(id){

let player = await getUser();
const { data: mission } = await supabase
.from("missions")
.select("*")
.eq("id", id)
.single();

if(Number(player.energy) < Number(mission.energy_cost)){
alert("Enerji yetersiz!");
return;
}

let success = Math.random()*100 < Number(mission.success_rate);

let newEnergy = Number(player.energy) - Number(mission.energy_cost);
let newXp = Number(player.xp);
let newYton = Number(player.yton);

if(success){
newXp += Number(mission.xp_reward);
newYton += Number(mission.yton_reward);
alert("BaÅŸarÄ±lÄ±!");
}else{
alert("BaÅŸarÄ±sÄ±z!");
}

await supabase
.from("users")
.update({
energy:newEnergy,
xp:newXp,
yton:newYton
})
.eq("id", userId);

renderUser();
}

renderUser();
loadMissions();

</script>

</body>
</html>
