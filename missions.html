<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Görevler - TonCrime</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body{margin:0;background:#000;color:#fff;font-family:Arial}
.topbar{height:60px;background:#111;display:flex;align-items:center;padding:0 15px}
.logo{color:#f90;font-weight:bold}
.wrapper{padding:15px}
.card{background:#111;padding:15px;border-radius:12px;margin-bottom:15px}
button{width:100%;padding:10px;background:#f90;border:none;border-radius:8px;font-weight:bold;margin-top:8px;cursor:pointer}
.small{font-size:12px;color:#aaa}
</style>
</head>
<body>

<div class="topbar">
<div class="logo">TonCrime - Görevler</div>
</div>

<div class="wrapper" id="missions"></div>

<script>

const supabaseClient = supabase.createClient(
"https://hwhscuyudwphnsipibpy.supabase.co",
"sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

let userId = localStorage.getItem("toncrime_user");

init();

async function init(){
renderMissions();
}

async function renderMissions(){
let { data } = await supabaseClient.from("missions").select("*");

let html = "";
data.forEach(m=>{
html += `
<div class="card">
<b>${m.name}</b><br>
Enerji: ${m.energy_cost}<br>
XP: ${m.xp_reward}<br>
Kazanç: ${m.yton_reward} YTon<br>
Başarı Oranı: %${m.success_rate}
<button onclick="startMission(${m.id})">Başlat</button>
</div>
`;
});

document.getElementById("missions").innerHTML = html;
}

async function startMission(missionId){

let now = Math.floor(Date.now()/1000);
let today = new Date().toISOString().split("T")[0];

let { data:user } = await supabaseClient
.from("users")
.select("*")
.eq("id", userId)
.single();

if(user.energy <= 0){
alert("Yeterli enerji yok!");
return;
}

let { data:mission } = await supabaseClient
.from("missions")
.select("*")
.eq("id", missionId)
.single();

let { data:stat } = await supabaseClient
.from("user_mission_stats")
.select("*")
.eq("user_id", userId)
.eq("mission_id", missionId)
.maybeSingle();

if(!stat){
await supabaseClient.from("user_mission_stats").insert({
user_id:userId,
mission_id:missionId,
repeat_count:0,
last_reset:today
});
stat = { repeat_count:0, last_reset:today };
}

if(stat.last_reset !== today){
await supabaseClient
.from("user_mission_stats")
.update({ repeat_count:0, last_reset:today })
.eq("id", stat.id);
stat.repeat_count = 0;
}

let repeat = stat.repeat_count + 1;

let successRate = mission.success_rate;

if(repeat > 10){
let risk = 100 - successRate;
risk = Math.min(risk * 2, 95);
successRate = 100 - risk;
}

let success = Math.random()*100 < successRate;

let newEnergy = user.energy - mission.energy_cost;
if(newEnergy < 0){
alert("Yeterli enerji yok!");
return;
}

let updateUser = {
energy:newEnergy,
last_active:now
};

let logText = "";

if(success){

let newXp = user.xp + mission.xp_reward;
let newYton = parseFloat(user.yton) + parseFloat(mission.yton_reward);
let level = user.level;
let xpReq = user.xp_required;

if(newXp >= xpReq){
newXp -= xpReq;
level += 1;
xpReq = Math.ceil(xpReq * 1.05);
}

updateUser.xp = newXp;
updateUser.yton = newYton;
updateUser.level = level;
updateUser.xp_required = xpReq;

logText = "Başarılı: " + mission.name;

}else{

if(Math.random()*100 < 70){
updateUser.hospital_until = now + 7200;
logText = "Dayak yedin ve hastanelik oldun!";
}else{
logText = "Başarısız: " + mission.name;
}
}

await supabaseClient.from("users").update(updateUser).eq("id", userId);

await supabaseClient
.from("user_mission_stats")
.update({ repeat_count: repeat })
.eq("user_id", userId)
.eq("mission_id", missionId);

await supabaseClient.from("activity_log").insert({
user_id:userId,
type:"Mission",
description:logText
});

alert(logText);
location.reload();
}

</script>
</body>
</html>
