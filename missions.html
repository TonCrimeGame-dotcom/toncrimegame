<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TonCrime</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{margin:0;background:#0e0e0e;font-family:Arial;color:white}
.header{
position:fixed;top:0;left:0;right:0;height:60px;
background:#111;display:flex;align-items:center;
justify-content:space-between;padding:0 15px;
border-bottom:1px solid #222;z-index:1000}
.logo{color:#ffb300;font-weight:bold;font-size:22px}
.stats{font-size:14px}
.menuBtn{cursor:pointer;font-size:22px;margin-right:10px}
.content{padding:80px 15px 20px}
.card{
background:#1a1a1a;padding:15px;border-radius:8px;
margin-bottom:15px}
button{
width:100%;padding:10px;border:none;
background:#ffb300;color:black;
border-radius:6px;font-weight:bold;cursor:pointer}
.userBox{
background:#1a1a1a;padding:15px;
border-radius:8px;margin-bottom:15px}
</style>
</head>
<body>

<div class="header">
<div>
<span class="menuBtn">â˜°</span>
<span class="logo">TonCrime</span>
</div>
<div class="stats" id="topStats">YÃ¼kleniyor...</div>
</div>

<div class="content">

<div class="userBox" id="userBox"></div>

<div id="missionsArea"></div>

</div>

<script>
const supabaseClient = supabase.createClient(
"https://hwhscuyudwphnsipibpy.supabase.co",
"sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

let userId = 591676206;

function xpNeeded(level){
return Math.floor(100 * Math.pow(1.05, level-1));
}

async function loadPlayer(){
let {data:user} = await supabaseClient
.from("users").select("*").eq("id",userId).single();

if(!user) return;

let needed = xpNeeded(user.level);

document.getElementById("topStats").innerHTML =
`Lv ${user.level} | XP ${user.xp}/${needed} | âš¡ ${user.energy}/100 | ðŸ’° ${user.yton}`;

document.getElementById("userBox").innerHTML =
`ID: ${user.id}<br>
Takma Ad: ${user.nickname}<br>
Level: ${user.level}<br>
XP: ${user.xp}/${needed}<br>
Silah HÄ±z AvantajÄ±: x1.00<br>
Toplam GÃ¶rev: ${user.total_missions || 0}<br>
Kazanma: ${user.wins || 0}<br>
Kaybetme: ${user.losses || 0}`;
}

async function loadMissions(){
let {data} = await supabaseClient.from("missions").select("*");
let html="";
data.forEach(m=>{
html+=`
<div class="card">
<b>${m.name}</b><br>
Enerji: ${m.energy_cost}<br>
XP: ${m.xp_reward}<br>
KazanÃ§: ${m.yton_reward} YTon<br>
BaÅŸarÄ±: %${m.success_rate}
<br><br>
<button onclick="startMission(${m.id})">BaÅŸlat</button>
</div>`;
});
document.getElementById("missionsArea").innerHTML=html;
}

async function startMission(id){

let {data:user} = await supabaseClient
.from("users").select("*").eq("id",userId).single();

let {data:mission} = await supabaseClient
.from("missions").select("*").eq("id",id).single();

if(user.energy < mission.energy_cost){
alert("Enerji yok");
return;
}

let success = Math.random()*100 <= mission.success_rate;

let newEnergy = user.energy - mission.energy_cost;
let newXp = user.xp;
let newYton = user.yton;
let newLevel = user.level;
let wins = user.wins || 0;
let losses = user.losses || 0;
let total = user.total_missions || 0;

total++;

if(success){
newXp += mission.xp_reward;
newYton += mission.yton_reward;
wins++;
}else{
losses++;
}

let needed = xpNeeded(newLevel);
while(newXp >= needed){
newXp -= needed;
newLevel++;
needed = xpNeeded(newLevel);
}

await supabaseClient.from("users")
.update({
energy:newEnergy,
xp:newXp,
yton:newYton,
level:newLevel,
wins:wins,
losses:losses,
total_missions:total
})
.eq("id",userId);

alert(success ? "BaÅŸarÄ±lÄ±!" : "BaÅŸarÄ±sÄ±z!");

loadPlayer();
}

async function energyRegen(){
let {data:user} = await supabaseClient
.from("users").select("*").eq("id",userId).single();

if(user.energy < 100){
await supabaseClient.from("users")
.update({energy:user.energy+1})
.eq("id",userId);
loadPlayer();
}
}

setInterval(energyRegen,300000);

loadPlayer();
loadMissions();
</script>

</body>
</html>
