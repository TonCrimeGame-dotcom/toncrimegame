<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TonCrime</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{margin:0;background:#0e0e0e;font-family:Arial;color:white}
.header{
position:fixed;top:0;left:0;right:0;height:60px;
background:#111;display:flex;align-items:center;
justify-content:space-between;padding:0 15px;
border-bottom:1px solid #222;z-index:1000}
.logo{color:#ffb300;font-weight:bold;font-size:22px}
.stats{font-size:14px}
.content{padding:80px 15px}
.card{background:#1a1a1a;padding:15px;border-radius:8px;margin-bottom:15px}
button{width:100%;padding:10px;border:none;background:#ffb300;color:black;border-radius:6px;font-weight:bold}
.userBox{background:#1a1a1a;padding:15px;border-radius:8px;margin-bottom:15px}
</style>
</head>
<body>

<div class="header">
<div class="logo">TonCrime</div>
<div class="stats" id="topStats"></div>
</div>

<div class="content">
<div class="userBox" id="userBox"></div>
<div id="missionsArea"></div>
</div>

<script>
const supabaseClient = supabase.createClient(
"https://hwhscuyudwphnsipibpy.supabase.co",
"sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

let userId = 591676206;

function xpNeeded(level){
return Math.floor(100 * Math.pow(1.05, level-1));
}

async function getUser(){
let {data} = await supabaseClient
.from("users").select("*").eq("id",userId).single();
return data;
}

async function updateUser(obj){
await supabaseClient.from("users")
.update(obj)
.eq("id",userId);
}

async function renderUser(){
let user = await getUser();
let needed = xpNeeded(user.level);

document.getElementById("topStats").innerHTML =
`Lv ${user.level} | XP ${user.xp}/${needed} | âš¡ ${user.energy}/100 | ðŸ’° ${user.yton}`;

document.getElementById("userBox").innerHTML =
`ID: ${user.id}<br>
Takma Ad: ${user.nickname}<br>
Level: ${user.level}<br>
XP: ${user.xp}/${needed}<br>
Toplam GÃ¶rev: ${user.total_missions || 0}<br>
Kazanma: ${user.wins || 0}<br>
Kaybetme: ${user.losses || 0}`;
}

async function loadMissions(){
let {data} = await supabaseClient.from("missions").select("*");
let html="";
data.forEach(m=>{
html+=`
<div class="card">
<b>${m.name}</b><br>
Enerji: ${m.energy_cost}<br>
XP: ${m.xp_reward}<br>
KazanÃ§: ${m.yton_reward} YTon<br>
BaÅŸarÄ±: %${m.success_rate}
<br><br>
<button onclick="startMission(${m.id})">BaÅŸlat</button>
</div>`;
});
document.getElementById("missionsArea").innerHTML=html;
}

async function startMission(id){

let user = await getUser();
let {data:mission} = await supabaseClient
.from("missions").select("*").eq("id",id).single();

if(user.energy < mission.energy_cost){
alert("Enerji yok!");
return;
}

let success = Math.random()*100 <= mission.success_rate;

let energy = user.energy - mission.energy_cost;
let xp = user.xp;
let yton = user.yton;
let level = user.level;
let wins = user.wins || 0;
let losses = user.losses || 0;
let total = user.total_missions || 0;

total++;

if(success){
xp += mission.xp_reward;
yton += mission.yton_reward;
wins++;
}else{
losses++;
}

let needed = xpNeeded(level);
while(xp >= needed){
xp -= needed;
level++;
needed = xpNeeded(level);
}

await updateUser({
energy:energy,
xp:xp,
yton:yton,
level:level,
wins:wins,
losses:losses,
total_missions:total
});

await renderUser();
alert(success ? "BaÅŸarÄ±lÄ±!" : "BaÅŸarÄ±sÄ±z!");
}

/* GERÃ‡EK ZAMANLI ENERJÄ° REGEN */
async function energyRegen(){

let user = await getUser();

if(user.energy >= 100) return;

let now = Math.floor(Date.now()/1000);

if(!user.last_energy_tick){
await updateUser({last_energy_tick:now});
return;
}

if(now - user.last_energy_tick >= 300){

let newEnergy = user.energy + 1;
if(newEnergy > 100) newEnergy = 100;

await updateUser({
energy:newEnergy,
last_energy_tick:now
});

await renderUser();
}
}

setInterval(energyRegen,10000);

renderUser();
loadMissions();
</script>

</body>
</html>
