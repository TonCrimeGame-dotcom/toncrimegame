<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TonCrime - Missions</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  margin:0;
  background:#0e0e0e;
  color:white;
  font-family:Arial;
  overflow-x:hidden;
}

/* TOPBAR */
.topbar {
  background:#111;
  padding:10px 15px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:bold;
  border-bottom:1px solid #222;
}

.menu-btn {
  cursor:pointer;
  font-size:22px;
}

/* SIDE MENU */
.sidebar {
  position:fixed;
  left:-250px;
  top:0;
  width:250px;
  height:100%;
  background:#151515;
  padding:20px;
  transition:0.3s;
  z-index:1000;
}

.sidebar.open {
  left:0;
}

.overlay {
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  z-index:900;
}

.overlay.show {
  display:block;
}

/* MAIN LAYOUT */
.container {
  display:flex;
  padding:15px;
  gap:20px;
}

.missions {
  flex:2;
}

.userpanel {
  flex:1;
  background:#151515;
  padding:15px;
  border-radius:8px;
  height:fit-content;
}

/* CARDS */
.card {
  background:#1b1b1b;
  padding:15px;
  margin-bottom:15px;
  border-radius:8px;
}

button {
  width:100%;
  padding:10px;
  background:gold;
  border:none;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>
<body>

<div class="topbar">
  <div class="menu-btn" onclick="openMenu()">‚ò∞</div>
  <div>TonCrime</div>
  <div id="stats">Y√ºkleniyor...</div>
</div>

<div class="sidebar" id="sidebar">
  <h3>Men√º</h3>
  <p>üè† Ana Sayfa</p>
  <p>üéØ G√∂revler</p>
  <p>üõí Market</p>
  <p>‚öî PvP</p>
</div>

<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<div class="container">
  <div class="missions" id="missions"></div>
  <div class="userpanel" id="userinfo"></div>
</div>

<script>

const SUPABASE_URL = "https://hwhscuyudwphnsipibpy.supabase.co";
const SUPABASE_KEY = "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu";
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const userId = "591676206";

/* MENU */
function openMenu(){
  document.getElementById("sidebar").classList.add("open");
  document.getElementById("overlay").classList.add("show");
}

function closeMenu(){
  document.getElementById("sidebar").classList.remove("open");
  document.getElementById("overlay").classList.remove("show");
}

/* DATA */
async function loadUser(){
  const { data } = await supabaseClient
    .from("users")
    .select("*")
    .eq("id", userId)
    .single();
  return data;
}

async function loadMissions(){
  const { data } = await supabaseClient
    .from("missions")
    .select("*");
  return data;
}

async function render(){
  const user = await loadUser();
  const missions = await loadMissions();

  document.getElementById("stats").innerHTML =
    `Lv ${user.level} | XP ${user.xp}/100 | ‚ö° ${user.energy} | üí∞ ${Number(user.yton).toFixed(2)}`;

  document.getElementById("userinfo").innerHTML = `
    <h3>Kullanƒ±cƒ±</h3>
    <b>ID:</b> ${user.id}<br>
    <b>Takma Ad:</b> ${user.nickname || "Yok"}<br>
    <b>Silah Avantajƒ±:</b> x1.00<br>
    <b>Toplam G√∂rev:</b> ${user.total_missions || 0}<br>
    <b>Kazanma:</b> ${user.wins || 0}<br>
    <b>Kaybetme:</b> ${user.losses || 0}
  `;

  let html = "";
  missions.forEach(m=>{
    html += `
      <div class="card">
        <b>${m.name}</b><br>
        Enerji: ${m.energy_cost}<br>
        XP: ${m.xp_reward}<br>
        Kazan√ß: ${m.yton_reward} Yton<br>
        Ba≈üarƒ±: %${m.success_rate}<br><br>
        <button onclick="startMission(${m.id})">Ba≈ülat</button>
      </div>
    `;
  });

  document.getElementById("missions").innerHTML = html;
}

async function startMission(missionId){
  const user = await loadUser();
  const { data: mission } = await supabaseClient
    .from("missions")
    .select("*")
    .eq("id", missionId)
    .single();

  if(user.energy < mission.energy_cost){
    alert("Yetersiz enerji!");
    return;
  }

  let newEnergy = user.energy - mission.energy_cost;
  let newXp = user.xp;
  let newYton = Number(user.yton);
  let newLevel = user.level;

  let total = (user.total_missions || 0) + 1;
  let wins = user.wins || 0;
  let losses = user.losses || 0;

  const success = Math.random()*100 < mission.success_rate;

  if(success){
    newXp += mission.xp_reward;
    newYton += mission.yton_reward;
    wins++;

    if(newXp >= 100){
      newLevel++;
      newXp -= 100;
    }

    alert("G√∂rev Ba≈üarƒ±lƒ±!");
  } else {
    losses++;
    alert("G√∂rev Ba≈üarƒ±sƒ±z!");
  }

  await supabaseClient
    .from("users")
    .update({
      energy: newEnergy,
      xp: newXp,
      yton: newYton,
      level: newLevel,
      total_missions: total,
      wins: wins,
      losses: losses
    })
    .eq("id", userId);

  render();
}

render();

</script>
</body>
</html>
