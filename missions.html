<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TonCrime - Missions</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{margin:0;background:#0e0e0e;font-family:Arial;color:white}
.topbar{
background:#111;
padding:12px;
display:flex;
justify-content:space-between;
align-items:center;
font-weight:bold;
position:fixed;
width:100%;
top:0;
z-index:999;
border-bottom:1px solid #222;
}
.logo{color:#ffb300;font-size:20px}
.container{padding-top:70px;padding-bottom:40px}
.card{
background:#1a1a1a;
margin:15px;
padding:15px;
border-radius:10px;
}
button{
background:#ffb300;
border:none;
padding:10px;
width:100%;
margin-top:10px;
font-weight:bold;
border-radius:6px;
cursor:pointer;
}
</style>
</head>
<body>

<div class="topbar">
<div class="logo">TonCrime</div>
<div id="stats">YÃ¼kleniyor...</div>
</div>

<div class="container">
<div id="playerInfo" class="card"></div>
<div id="missions"></div>
</div>

<script>

const supabase = window.supabase.createClient(
"https://hwhscuyudwphnsipibpy.supabase.co",
"sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

let userId = 591676206;

function xpNeeded(level){
return Math.floor(100 * Math.pow(1.05, level-1));
}

async function getUser(){
const { data } = await supabase
.from("users")
.select("*")
.eq("id", userId)
.single();
return data;
}

async function updateUser(obj){
await supabase
.from("users")
.update(obj)
.eq("id", userId);
}

async function renderUser(){
let user = await getUser();
let needed = xpNeeded(user.level);

document.getElementById("stats").innerHTML =
`Lv ${user.level} | XP ${user.xp}/${needed} | âš¡ ${user.energy}/100 | ðŸ’° ${user.yton}`;

document.getElementById("playerInfo").innerHTML = `
ID: ${user.id}<br>
Takma Ad: ${user.nickname}<br>
Level: ${user.level}<br>
XP: ${user.xp}/${needed}
`;
}

async function loadMissions(){
const { data } = await supabase.from("missions").select("*");

let html = "";

data.forEach(m=>{
html += `
<div class="card">
<b>${m.name}</b><br>
Enerji: ${m.energy_cost}<br>
XP: ${m.xp_reward}<br>
KazanÃ§: ${m.yton_reward} YTon<br>
BaÅŸarÄ±: %${m.success_rate}
<button onclick="startMission(${m.id})">BaÅŸlat</button>
</div>
`;
});

document.getElementById("missions").innerHTML = html;
}

async function startMission(id){

let player = await getUser();
const { data: mission } = await supabase
.from("missions")
.select("*")
.eq("id", id)
.single();

if(Number(player.energy) < Number(mission.energy_cost)){
alert("Enerji yetersiz!");
return;
}

let success = Math.random()*100 < Number(mission.success_rate);

let newEnergy = Number(player.energy) - Number(mission.energy_cost);
let newXp = Number(player.xp);
let newYton = Number(player.yton);
let newLevel = Number(player.level);

if(success){
newXp += Number(mission.xp_reward);
newYton += Number(mission.yton_reward);
alert("BaÅŸarÄ±lÄ±!");
}else{
alert("BaÅŸarÄ±sÄ±z!");
}

let needed = xpNeeded(newLevel);
while(newXp >= needed){
newXp -= needed;
newLevel++;
needed = xpNeeded(newLevel);
}

await updateUser({
energy:newEnergy,
xp:newXp,
yton:newYton,
level:newLevel
});

await renderUser();
}

/* 5 Dakika Enerji Regen */
async function energyRegen(){
let user = await getUser();
if(user.energy >= 100) return;

let now = Math.floor(Date.now()/1000);

if(!user.last_energy_tick){
await updateUser({last_energy_tick:now});
return;
}

if(now - user.last_energy_tick >= 300){

let newEnergy = Number(user.energy) + 1;
if(newEnergy > 100) newEnergy = 100;

await updateUser({
energy:newEnergy,
last_energy_tick:now
});

await renderUser();
}
}

setInterval(energyRegen,10000);

renderUser();
loadMissions();

</script>

</body>
</html>
