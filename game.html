<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YeraltÄ± Åehri</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{
margin:0;
background:#000;
color:#fff;
font-family:Arial;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
text-align:center;
}
.box{
background:#111;
padding:25px;
border-radius:12px;
width:90%;
max-width:400px;
}
h2{color:#f90}
button{
margin-top:12px;
width:100%;
padding:12px;
background:#f90;
border:none;
border-radius:8px;
font-weight:bold;
cursor:pointer;
}
</style>
</head>
<body>

<div class="box" id="content">
<h2>YÃ¼kleniyor...</h2>
</div>

<script>

/* AGE */
if(localStorage.getItem("ageVerified")!=="true"){
window.location.href="index.html";
}

/* SUPABASE */
const supabaseClient = supabase.createClient(
"https://hwhscuyudwphnsipibpy.supabase.co",
"sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

/* TELEGRAM */
const tg = window.Telegram?.WebApp;
if(tg){ tg.expand(); }

const user = tg?.initDataUnsafe?.user;

if(!user){
document.getElementById("content").innerHTML =
"<h2>Telegram kullanÄ±cÄ± bilgisi alÄ±namadÄ±.</h2>";
}else{
initUser(user.id);
}

async function initUser(userId){

let { data } = await supabaseClient
.from("users")
.select("*")
.eq("id", userId)
.maybeSingle();

if(!data){
await supabaseClient.from("users").insert({ id: userId });
let { data: newUser } = await supabaseClient
.from("users")
.select("*")
.eq("id", userId)
.single();
data = newUser;
}

await handleEnergy(data);
}

async function handleEnergy(data){

let now = Math.floor(Date.now()/1000);

/* HASTANE */
if(now < data.hospital_until){
render(data,true);
return;
}

/* ENERGY REGEN */
if(data.energy < 100){

let diff = now - data.last_energy_update;
let gain = Math.floor(diff / 300);

if(gain > 0){
let newEnergy = Math.min(100, data.energy + gain);

await supabaseClient
.from("users")
.update({
energy: newEnergy,
last_energy_update: now
})
.eq("id", data.id);

data.energy = newEnergy;
}
}

render(data,false);
}

function render(data,inHospital){

let hospitalBlock = "";

if(inHospital){
hospitalBlock = `
<p style="color:#ff4444;">ğŸ¥ Hastanedeysin</p>
<button onclick="buyEnergy(${data.id})">1 Enerji = 1 YTON</button>
`;
}

document.getElementById("content").innerHTML = `
<h2>ğŸ”¥ YeraltÄ± Åehri</h2>
<p>ID: ${data.id}</p>
<p>ğŸ‘¤ ${data.nickname || "Takma ad yok"}</p>
<p>Level: ${data.level}</p>
<p>âš¡ ${data.energy}/100</p>
<p>ğŸ’° ${data.yton}</p>
${hospitalBlock}
<button onclick="testHospital(${data.id})">Test: Hastaneye DÃ¼ÅŸ</button>
`;
}

async function buyEnergy(userId){

let { data } = await supabaseClient
.from("users")
.select("*")
.eq("id", userId)
.single();

if(data.yton < 1){
alert("YTON yetersiz");
return;
}

await supabaseClient
.from("users")
.update({
energy: data.energy + 1,
yton: data.yton - 1
})
.eq("id", userId);

location.reload();
}

async function testHospital(userId){

let now = Math.floor(Date.now()/1000);

await supabaseClient
.from("users")
.update({
hospital_until: now + 600
})
.eq("id", userId);

location.reload();
}

</script>

</body>
</html>
