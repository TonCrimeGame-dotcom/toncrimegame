<script>

if(localStorage.getItem("ageVerified")!=="true"){
window.location.href="index.html";
}

const supabase = window.supabase.createClient(
"https://hwhscuyudwphnsipibpy.supabase.co",
"sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

const tg = window.Telegram?.WebApp;
let user = tg?.initDataUnsafe?.user;

if(!user){
document.getElementById("content").innerHTML =
"<h2>Telegram kullanÄ±cÄ± bilgisi alÄ±namadÄ±.</h2>";
}else{
initUser(user.id);
}

async function initUser(userId){

let { data } = await supabase
.from("users")
.select("*")
.eq("id", userId)
.single();

if(!data){
await supabase.from("users").insert({ id: userId });
let { data: newUser } = await supabase
.from("users")
.select("*")
.eq("id", userId)
.single();
showGame(newUser);
}else{
await handleEnergyRegen(data);
}

}

async function handleEnergyRegen(data){

let now = Math.floor(Date.now()/1000);

if(now < data.hospital_until){
showGame(data,true);
return;
}

if(data.energy < 100){

let diff = now - data.last_energy_update;
let gained = Math.floor(diff / 300); // 5 dk = 300 sn

if(gained > 0){
let newEnergy = Math.min(100, data.energy + gained);
await supabase
.from("users")
.update({
energy: newEnergy,
last_energy_update: now
})
.eq("id", data.id);

data.energy = newEnergy;
data.last_energy_update = now;
}
}

showGame(data,false);
}

function showGame(data,inHospital){

let hospitalText = "";

if(inHospital){
hospitalText = `<p style="color:#ff4444;">ğŸ¥ Hastanedeysin</p>
<button onclick="buyEnergy(${data.id})">1 Enerji = 1 YTON</button>`;
}

document.getElementById("content").innerHTML = `
<h2>ğŸ”¥ YeraltÄ± Åehri</h2>
<p>ID: ${data.id}</p>
<p>ğŸ‘¤ ${data.nickname || "Takma ad yok"}</p>
<p>Level: ${data.level}</p>
<p>âš¡ ${data.energy}/100</p>
<p>ğŸ’° ${data.yton}</p>
${hospitalText}
<button onclick="simulateHospital(${data.id})">Test: Hastaneye DÃ¼ÅŸ</button>
`;
}

async function buyEnergy(userId){

let { data } = await supabase
.from("users")
.select("*")
.eq("id", userId)
.single();

if(data.yton < 1){
alert("YTON yetersiz");
return;
}

await supabase
.from("users")
.update({
energy: data.energy + 1,
yton: data.yton - 1
})
.eq("id", userId);

location.reload();
}

async function simulateHospital(userId){

let now = Math.floor(Date.now()/1000);

await supabase
.from("users")
.update({
hospital_until: now + 600
})
.eq("id", userId);

location.reload();
}

</script>
