<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TonCrime</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body{margin:0;background:#000;color:#fff;font-family:Arial}
.topbar{height:60px;background:#111;display:flex;align-items:center;padding:0 15px}
.logo{color:#f90;font-weight:bold;font-size:18px}
.topstats{margin-left:auto;font-size:13px;text-align:right}
.band{background:#151515;padding:8px 15px;font-size:13px;border-bottom:1px solid #222}
.wrapper{padding:15px}
.card{background:#111;padding:15px;border-radius:12px;margin-bottom:15px}
</style>
</head>
<body>

<div class="topbar">
<div class="logo">TonCrime</div>
<div class="topstats" id="topStats">YÃ¼kleniyor...</div>
</div>

<div class="band" id="cityBand">YÃ¼kleniyor...</div>
<div class="wrapper" id="content"></div>

<script>

const supabaseClient = supabase.createClient(
"https://hwhscuyudwphnsipibpy.supabase.co",
"sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

let userId = localStorage.getItem("toncrime_user");
if(!userId){
userId = Math.floor(Math.random()*1000000000);
localStorage.setItem("toncrime_user", userId);
}

init();

async function init(){
try{
let now = Math.floor(Date.now()/1000);

let { data, error } = await supabaseClient
.from("users")
.select("*")
.eq("id", userId)
.maybeSingle();

if(error) throw error;

if(!data){
let insert = await supabaseClient.from("users").insert({
id:userId,
nickname:"TestUser",
level:1,
xp:0,
xp_required:100,
energy:100,
yton:10,
last_energy_update:now,
last_active:now,
hospital_until:0
});
if(insert.error) throw insert.error;

let res = await supabaseClient.from("users").select("*").eq("id",userId).single();
if(res.error) throw res.error;
data = res.data;
}

await supabaseClient.from("users")
.update({ last_active: now })
.eq("id", userId);

data = await handleEnergy(data);
render(data);
updateCityBand();

}catch(e){
document.getElementById("content").innerHTML =
"<div class='card'>HATA: "+ e.message +"</div>";
console.error(e);
}
}

async function handleEnergy(data){
try{
let now = Math.floor(Date.now()/1000);

if(now < data.hospital_until) return data;

if(data.energy < 100){
let diff = now - data.last_energy_update;
let gain = Math.floor(diff / 300);

if(gain > 0){
let newEnergy = Math.min(100, data.energy + gain);

let update = await supabaseClient
.from("users")
.update({
energy:newEnergy,
last_energy_update:now
})
.eq("id", data.id);

if(update.error) throw update.error;

data.energy = newEnergy;
}
}
return data;
}catch(e){
console.error(e);
return data;
}
}

function render(data){
document.getElementById("topStats").innerHTML =
`Lv ${data.level}<br>XP ${data.xp}/${data.xp_required}<br>âš¡ ${data.energy}/100<br>ðŸ’° ${data.yton}`;

document.getElementById("content").innerHTML = `
<div class="card">
<b>ID:</b> ${data.id}<br>
<b>Takma Ad:</b> ${data.nickname}<br>
<b>Level:</b> ${data.level}<br>
<b>XP:</b> ${data.xp}/${data.xp_required}
</div>
`;
}

async function updateCityBand(){
try{
let now = Math.floor(Date.now()/1000);

let { count, error } = await supabaseClient
.from("users")
.select("*",{count:"exact",head:true})
.gte("last_active", now-300);

if(error) throw error;

let date = new Date();
let formatted = date.toLocaleDateString("tr-TR");
let time = date.toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});

document.getElementById("cityBand").innerHTML =
`ðŸ“… ${formatted} | ðŸ•’ ${time} | ðŸ‘¥ ${count} aktif`;
}catch(e){
console.error(e);
}
}

setInterval(updateCityBand,60000);

</script>
</body>
</html>
