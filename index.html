<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TonCrime</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body{margin:0;background:#0e0e0e;color:white;font-family:Arial}
.topbar{position:fixed;top:0;left:0;width:100%;background:#111;padding:15px 30px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #222;z-index:2000}
.logo{color:gold;font-size:22px;font-weight:bold}
.menu-btn{cursor:pointer;color:gold;font-size:20px}
.sidebar{position:fixed;top:0;left:-260px;width:240px;height:100%;background:#151515;padding:20px;transition:.3s;z-index:3000}
.sidebar.open{left:0}
.overlay{position:fixed;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;z-index:2500}
.overlay.show{display:block}
.main{margin-top:90px;padding:40px}
.bar{height:8px;background:#333;border-radius:5px;overflow:hidden;margin-bottom:6px}
.fill{height:100%;transition:.3s}
.xp{background:limegreen}
.energy{background:gold}
button{padding:8px 15px;background:gold;border:none;cursor:pointer;font-weight:bold}
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
<h3 style="color:gold">MenÃ¼</h3>
<p onclick="go('missions.html')">GÃ¶revler</p>
<p onclick="go('pvp.html')">PvP</p>
<p onclick="go('coffeeshop.html')">Coffee</p>
<p onclick="go('nightclub.html')">NightClub</p>
<p onclick="go('hospital.html')">Hastane</p>
<p onclick="logout()">Ã‡Ä±kÄ±ÅŸ</p>
</div>
<div class="overlay" id="overlay"></div>

<div class="topbar">
<div><span class="menu-btn" onclick="toggleMenu()">â˜°</span> <span class="logo">TonCrime</span></div>
<div>
<div id="stats"></div>
<div class="bar"><div class="fill xp" id="xpBar"></div></div>
<div class="bar"><div class="fill energy" id="energyBar"></div></div>
</div>
</div>

<div class="main">
<h2>Turnuva & Sezon Merkezi</h2>
<div id="seasonArea"></div>
</div>

<script>

/* ================= CORE ================= */

const SUPABASE_URL="https://hwhscuyudwphnsipibpy.supabase.co";
const SUPABASE_KEY="sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu";
const db=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const MAX_ENERGY=100;
const XP_LIMIT=100;
const ENERGY_INTERVAL=300000;

/* ================= DEVICE ================= */

if(!localStorage.getItem("device_id")){
  localStorage.setItem("device_id",crypto.randomUUID());
}

/* ================= MENU ================= */

function toggleMenu(){
  sidebar.classList.toggle("open");
  overlay.classList.toggle("show");
}
overlay.onclick=toggleMenu;
function go(p){window.location.href=p}
function logout(){localStorage.clear();location.reload();}

/* ================= USER ================= */

async function loadUser(){
  const id=localStorage.getItem("tc_user");
  if(!id)return null;
  const {data}=await db.from("users").select("*").eq("id",id).single();
  return data;
}

/* ================= ENGINE ================= */

async function regenEnergy(user){
  const now=Date.now();
  if(!user.last_energy_tick){
    await db.from("users").update({last_energy_tick:now}).eq("id",user.id);
    user.last_energy_tick=now;
  }
  const diff=now-user.last_energy_tick;
  const add=Math.floor(diff/ENERGY_INTERVAL);
  if(add>0 && user.energy<MAX_ENERGY){
    user.energy=Math.min(MAX_ENERGY,user.energy+add);
    user.last_energy_tick+=add*ENERGY_INTERVAL;
    await db.from("users").update({
      energy:user.energy,
      last_energy_tick:user.last_energy_tick
    }).eq("id",user.id);
  }
  return user;
}

function renderStats(user){
  stats.innerHTML=`Lv ${user.level} | XP ${user.xp}/100 | âš¡ ${user.energy} | ðŸ’° ${user.yton}`;
  xpBar.style.width=(user.xp/XP_LIMIT*100)+"%";
  energyBar.style.width=(user.energy/MAX_ENERGY*100)+"%";
}

/* ================= GAME CORE ================= */

async function addXP(user,xp){
  user.xp+=xp;
  if(user.xp>=XP_LIMIT){
    user.level++;
    user.xp-=XP_LIMIT;
  }
  await db.from("users").update({
    xp:user.xp,
    level:user.level
  }).eq("id",user.id);
}

/* ================= PVP RANK ================= */

function calculateELO(playerRating,opponentRating,result){
  const K=32;
  const expected=1/(1+Math.pow(10,(opponentRating-playerRating)/400));
  return Math.round(playerRating+K*(result-expected));
}

/* ================= DAILY BONUS ================= */

async function dailyBonus(user){
  const today=new Date().toDateString();
  if(user.last_daily!==today){
    await db.from("users").update({
      yton:user.yton+2,
      last_daily:today
    }).eq("id",user.id);
    alert("Daily Bonus +2 Yton");
  }
}

/* ================= SEASON SYSTEM ================= */

function getSeasonBadge(points){
  if(points>500)return "Diamond";
  if(points>300)return "Gold";
  if(points>150)return "Silver";
  return "Bronze";
}

async function renderSeason(user){
  const badge=getSeasonBadge(user.season_points||0);
  seasonArea.innerHTML=
  `<h3>Sezon Rozeti: ${badge}</h3>
   Sezon PuanÄ±: ${user.season_points||0}`;
}

/* ================= RESET SYSTEM ================= */

function dailyReset(){
  const now=new Date();
  if(now.getHours()===0 && now.getMinutes()===0){
    console.log("Daily reset triggered");
  }
}

/* ================= REALTIME ================= */

function subscribePvP(){
  db.channel('pvp-live')
    .on('postgres_changes',{event:'UPDATE',schema:'public',table:'pvp_matches'},payload=>{
      console.log("Realtime match update:",payload.new);
    })
    .subscribe();
}

/* ================= INIT ================= */

async function init(){
  const user=await loadUser();
  if(!user)return;
  await regenEnergy(user);
  renderStats(user);
  await dailyBonus(user);
  await renderSeason(user);
  subscribePvP();
}

init();
setInterval(init,10000);
setInterval(dailyReset,60000);

</script>
</body>
</html>
