<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TonCrime</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@tonconnect/ui@2.0.0/dist/tonconnect-ui.min.js"></script>

<style>
body{
margin:0;
background:#0e0e0e;
color:white;
font-family:Arial;
}

/* ===== TOPBAR ===== */

.topbar{
display:flex;
justify-content:space-between;
align-items:center;
background:#111;
padding:14px 20px;
border-bottom:1px solid #222;
}

.logo{color:gold;font-weight:bold;font-size:20px}

.bar{
height:6px;
background:#333;
border-radius:4px;
overflow:hidden;
margin-top:4px;
}

.fill{height:100%}
.xp{background:limegreen}
.energy{background:gold}

/* ===== LAYOUT ===== */

.layout{
display:flex;
}

.sidebar{
width:220px;
background:#151515;
min-height:100vh;
padding:15px;
}

.sidebar div{
padding:10px;
cursor:pointer;
border-bottom:1px solid #222;
}

.sidebar div:hover{
background:#222;
}

.content{
flex:1;
padding:20px;
}

.card{
background:#1b1b1b;
padding:15px;
border-radius:10px;
margin-bottom:15px;
}
</style>
</head>

<body>

<div class="topbar">
<div class="logo">üî• TonCrime</div>

<div style="width:320px">
<div id="stats"></div>

<div class="bar"><div id="xpBar" class="fill xp"></div></div>
<div class="bar"><div id="energyBar" class="fill energy"></div></div>

<div id="onlinePlayers"></div>
</div>
</div>

<div class="layout">

<div class="sidebar">

<div onclick="ROUTER.go('home')">üè† Ana Sayfa</div>
<div onclick="ROUTER.go('missions')">üéØ G√∂revler</div>
<div onclick="ROUTER.go('pvp')">‚öî PvP</div>
<div onclick="ROUTER.go('market')">üõí Market</div>
<div onclick="ROUTER.go('clans')">üë• Clan</div>
<div onclick="ROUTER.go('territory')">üó∫ B√∂lgeler</div>
<div onclick="ROUTER.go('leaderboard')">üèÜ Liderler</div>

<div id="walletButton"></div>

</div>

<div class="content" id="tc-content"></div>

</div>

<div id="crimeFeed"></div>

<script>

/* ===================================================
CONFIG
=================================================== */

window.CONFIG={
SUPABASE_URL:"https://hwhscuyudwphnsipibpy.supabase.co",
SUPABASE_KEY:"sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu",
USER_ID:localStorage.getItem("tc_user")||"591676206",
MAX_ENERGY:100,
XP_LIMIT:100,
ENERGY_INTERVAL:300000
};

window.db = supabase.createClient(
CONFIG.SUPABASE_URL,
CONFIG.SUPABASE_KEY
);

/* ===================================================
EVENT BUS
=================================================== */

window.EVENT={
events:{},
emit(n,d){(this.events[n]||[]).forEach(f=>f(d));},
on(n,f){(this.events[n]||(this.events[n]=[])).push(f);}
};

/* ===================================================
GLOBAL GAME STATE
=================================================== */

window.GAME={
user:null
};

/* ===================================================
LOAD USER
=================================================== */

async function loadUser(){
const {data}=await db
.from("users")
.select("*")
.eq("id",CONFIG.USER_ID)
.single();

GAME.user=data;
renderStats();
EVENT.emit("game:ready");
}

/* ===================================================
UI
=================================================== */

function renderStats(){

const u=GAME.user;
if(!u) return;

document.getElementById("stats").innerHTML=
`Lv ${u.level} | XP ${u.xp}/${CONFIG.XP_LIMIT}
 | ‚ö° ${u.energy} | üí∞ ${Number(u.yton).toFixed(2)}`;

document.getElementById("xpBar").style.width=
(u.xp/CONFIG.XP_LIMIT*100)+"%";

document.getElementById("energyBar").style.width=
(u.energy/CONFIG.MAX_ENERGY*100)+"%";
}

/* ===================================================
ENERGY REGEN LOOP
=================================================== */

async function regenEnergy(){

const u=GAME.user;
if(!u) return;

const now=Date.now();

if(!u.last_energy_tick){
u.last_energy_tick=now;
await db.from("users")
.update({last_energy_tick:now})
.eq("id",u.id);
return;
}

const diff=now-u.last_energy_tick;
const gain=Math.floor(diff/CONFIG.ENERGY_INTERVAL);

if(gain<=0) return;

u.energy=Math.min(CONFIG.MAX_ENERGY,u.energy+gain);
u.last_energy_tick+=gain*CONFIG.ENERGY_INTERVAL;

await db.from("users").update({
energy:u.energy,
last_energy_tick:u.last_energy_tick
}).eq("id",u.id);

renderStats();
}

setInterval(regenEnergy,60000);

/* ===================================================
ROUTER
=================================================== */

window.ROUTER={

go(page){

EVENT.emit("page:enter",page);

const root=document.getElementById("tc-content");

if(page==="home"){
root.innerHTML=`
<div class="card">≈ûehre ho≈ügeldin.</div>
<div id="crimeFeed"></div>`;
}

}

};

/* ===================================================
ONLINE PRESENCE
=================================================== */

function startPresence(){

const channel=db.channel("online-users",{
config:{presence:{key:CONFIG.USER_ID}}
});

channel.on("presence",{event:"sync"},()=>{

const state=channel.presenceState();
document.getElementById("onlinePlayers")
.innerText="üü¢ Online: "+Object.keys(state).length;

});

channel.subscribe(async()=>{
await channel.track({online:true});
});

}

/* ===================================================
TON WALLET
=================================================== */

new TON_CONNECT_UI.TonConnectUI({
manifestUrl:location.origin+"/tonconnect-manifest.json",
buttonRootId:"walletButton"
});

/* ===================================================
BOOT
=================================================== */

async function boot(){

await loadUser();
startPresence();

ROUTER.go("home");

console.log("üî• TONCRIME TEST BUILD READY");
}

boot();

</script>

</body>
</html>
