<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TonCrime</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:Arial}
.topbar{height:60px;background:#111;display:flex;align-items:center;padding:0 15px}
.menu-btn{font-size:22px;cursor:pointer;margin-right:15px}
.logo{color:#f90;font-weight:bold;font-size:18px}
.topstats{margin-left:auto;font-size:13px;text-align:right}
.band{background:#151515;padding:8px 15px;font-size:13px;border-bottom:1px solid #222}
.wrapper{padding:15px}
.card{background:#111;padding:15px;border-radius:12px;margin-bottom:15px}
button{width:100%;padding:10px;background:#f90;border:none;border-radius:8px;font-weight:bold;margin-top:8px;cursor:pointer}
.sidebar{position:fixed;top:0;left:-260px;width:260px;height:100%;background:#111;padding:20px;transition:0.3s;z-index:1000}
.sidebar.active{left:0}
.overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;z-index:900}
.overlay.active{display:block}
.lock{opacity:0.4}
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
<div onclick="closeMenu()">âœ– Kapat</div>
<hr>
<div>ğŸ  Ana Panel</div>
<div>ğŸ¯ GÃ¶revler</div>
<div>âš” PvP Arena</div>
<div>ğŸ¸ Gece KulÃ¼bÃ¼</div>
<div>â˜• Smoke&Smart</div>
<div id="loungeBtn">ğŸ’ƒ Lounge House</div>
<div>ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</div>
<div>ğŸ¥ Hastane</div>
<div id="businessBtn">ğŸ’¼ Ä°ÅŸ HayatÄ±m</div>
<div>ğŸ† Turnuva</div>
</div>

<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<div class="topbar">
<div class="menu-btn" onclick="openMenu()">â˜°</div>
<div class="logo">TonCrime</div>
<div class="topstats" id="topStats"></div>
</div>

<div class="band" id="cityBand">YÃ¼kleniyor...</div>

<div class="wrapper" id="content"></div>

<script>

const supabaseClient = supabase.createClient(
"https://hwhscuyudwphnsipibpy.supabase.co",
"sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

const tg = window.Telegram?.WebApp;
if(tg){ tg.expand(); }

const user = tg?.initDataUnsafe?.user;

if(!user){
document.getElementById("content").innerHTML = "Telegram bilgisi alÄ±namadÄ±.";
}else{
init(user.id);
}

function openMenu(){
document.getElementById("sidebar").classList.add("active");
document.getElementById("overlay").classList.add("active");
}
function closeMenu(){
document.getElementById("sidebar").classList.remove("active");
document.getElementById("overlay").classList.remove("active");
}

async function init(userId){

let now = Math.floor(Date.now()/1000);

let { data } = await supabaseClient
.from("users")
.select("*")
.eq("id", userId)
.maybeSingle();

if(!data){
await supabaseClient.from("users").insert({
id:userId,
last_energy_update:now,
last_active:now
});
let res = await supabaseClient.from("users").select("*").eq("id",userId).single();
data = res.data;
}

await supabaseClient.from("users")
.update({ last_active: now })
.eq("id", userId);

data = await handleEnergy(data);
render(data);
updateCityBand();
}

async function handleEnergy(data){

let now = Math.floor(Date.now()/1000);

if(now < data.hospital_until) return data;

if(data.energy < 100){

let diff = now - data.last_energy_update;
let gain = Math.floor(diff / 300);

if(gain > 0){
let newEnergy = Math.min(100, data.energy + gain);

await supabaseClient
.from("users")
.update({
energy:newEnergy,
last_energy_update:now
})
.eq("id", data.id);

data.energy = newEnergy;
}
}
return data;
}

async function render(data){

let weapon = await supabaseClient
.from("weapons")
.select("*")
.eq("id", data.weapon_id)
.maybeSingle();

let pvpStats = await supabaseClient
.from("pvp_stats")
.select("*")
.eq("user_id", data.id)
.maybeSingle();

let logs = await supabaseClient
.from("activity_log")
.select("*")
.eq("user_id", data.id)
.order("created_at",{ascending:false})
.limit(10);

document.getElementById("topStats").innerHTML =
`Lv ${data.level}<br>XP ${data.xp}/${data.xp_required}<br>âš¡ ${data.energy}/100<br>ğŸ’° ${data.yton}`;

let hospitalBlock = "";
if(Math.floor(Date.now()/1000) < data.hospital_until){
hospitalBlock = `<p style="color:#ff4444">ğŸ¥ Hastanedeysin</p>`;
}

document.getElementById("content").innerHTML = `
<div class="card">
<b>ID:</b> ${data.id}<br>
<b>Takma Ad:</b> ${data.nickname || "Yok"}<br>
<b>Level:</b> ${data.level}<br>
<b>XP:</b> ${data.xp}/${data.xp_required}
</div>

<div class="card">
<b>ğŸ”« Silah:</b> ${weapon.data?.name || "Yok"}<br>
GÃ¼Ã§: ${weapon.data?.power || 0}<br>
SÃ¼re Ã‡arpanÄ±: x${weapon.data?.time_multiplier || 1}
</div>

<div class="card">
<b>PvP:</b><br>
Win: ${pvpStats.data?.wins || 0}<br>
Lose: ${pvpStats.data?.losses || 0}<br>
Ortalama SÃ¼re: ${pvpStats.data?.avg_time || 0}
</div>

<div class="card">
<b>Enerji:</b> ${data.energy}/100
${hospitalBlock}
</div>

<div class="card">
<b>Son 10 Aktivite</b><br>
${logs.data.map(l=>`<div>${l.type} - ${l.description}</div>`).join("")}
</div>
`;

if(data.level < 50){
document.getElementById("loungeBtn").classList.add("lock");
document.getElementById("businessBtn").classList.add("lock");
}
}

async function updateCityBand(){

let now = Math.floor(Date.now()/1000);
let { count } = await supabaseClient
.from("users")
.select("*",{count:"exact",head:true})
.gte("last_active", now-300);

let date = new Date();
let formatted = date.toLocaleDateString("tr-TR",{day:"numeric",month:"long",year:"numeric"});
let time = date.toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});

let status = "Åehir sessiz";
if(count>50) status="Åehir hareketli";
if(count>150) status="Åehir kaynÄ±yor";

document.getElementById("cityBand").innerHTML =
`ğŸ“… ${formatted} | ğŸ•’ ${time} | ğŸ‘¥ ${count} oyuncu aktif | ğŸ”¥ ${status}`;
}

setInterval(updateCityBand,60000);

</script>
</body>
</html>
