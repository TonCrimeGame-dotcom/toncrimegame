<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TonCrime</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{margin:0;background:#0e0e0e;color:white;font-family:Arial;}
.login-screen{position:fixed;width:100%;height:100%;background:#0e0e0e;display:flex;justify-content:center;align-items:center;flex-direction:column;z-index:5000;}
.login-box{background:#1b1b1b;padding:40px;border-radius:12px;width:320px;text-align:center;}
input{width:100%;padding:10px;margin:10px 0;border:none;border-radius:6px;}
button{width:100%;padding:12px;background:gold;border:none;font-weight:bold;cursor:pointer;border-radius:6px;}
button:hover{opacity:0.9}
.topbar{background:#111;padding:18px 40px;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center;}
.left-top{display:flex;align-items:center;gap:15px;}
.menu-btn{font-size:22px;cursor:pointer;}
.logo{font-size:24px;font-weight:bold;color:gold;}
.right-stats{width:420px;}
.stat-text{text-align:right;margin-bottom:6px;}
.bar-label{font-size:12px;text-align:right;margin-bottom:3px;}
.bar{width:100%;height:8px;background:#333;border-radius:5px;overflow:hidden;margin-bottom:6px;}
.bar-fill{height:100%;transition:0.3s;}
.xp-fill{background:limegreen;}
.energy-fill{background:gold;}
.energy-timer{font-size:11px;text-align:right;color:#aaa;}
.sidebar{position:fixed;top:0;left:-260px;width:250px;height:100%;background:#151515;padding:25px;transition:0.3s;z-index:2000;}
.sidebar.open{left:0;}
.overlay{position:fixed;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;z-index:1500;}
.overlay.show{display:block;}
.main{display:flex;justify-content:center;gap:40px;padding:40px;}
.center-area{width:55%;}
.userpanel{width:25%;background:#151515;padding:20px;border-radius:10px;height:fit-content;}
.card{background:#1b1b1b;padding:18px;margin-bottom:25px;border-radius:10px;}
@media(max-width:1100px){.main{flex-direction:column;align-items:center;}.center-area,.userpanel{width:90%;}}
</style>
</head>
<body>

<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <h2 style="color:gold;">TonCrime</h2>
    <p>18 yaÅŸÄ±ndan bÃ¼yÃ¼k mÃ¼sÃ¼n?</p>
    <button onclick="confirmAge()">Evet, 18+</button>
    <div id="nickArea" style="display:none;">
      <input id="nicknameInput" placeholder="Takma ad gir">
      <button onclick="startGame()">Oyuna BaÅŸla</button>
    </div>
  </div>
</div>

<div class="sidebar" id="sidebar">
  <h3 style="color:gold">MenÃ¼</h3>
  <p>ğŸ  Ana Sayfa</p>
  <p onclick="location.href='missions.html'">ğŸ¯ GÃ¶revler</p>
  <p>âš” PvP</p>
  <p>ğŸ”« Silahlar</p>
</div>
<div class="overlay" id="overlay"></div>

<div class="topbar">
  <div class="left-top">
    <div class="menu-btn" onclick="openMenu()">â˜°</div>
    <div class="logo">TonCrime</div>
  </div>

  <div class="right-stats">
    <div class="stat-text" id="stats"></div>
    <div class="bar-label">XP</div>
    <div class="bar"><div class="bar-fill xp-fill" id="xpBar"></div></div>
    <div class="bar-label">Enerji</div>
    <div class="bar"><div class="bar-fill energy-fill" id="energyBar"></div></div>
    <div class="energy-timer" id="energyTimer"></div>
  </div>
</div>

<div class="main">
  <div class="center-area">
    <div class="card">
      <h3>ğŸ† HaftalÄ±k Turnuva</h3>
      Ã–dÃ¼l Havuzu: 500 Yton<br>
      SÃ¼re: 3 GÃ¼n<br>
      KatÄ±lÄ±m: 6 Yton
    </div>
    <div class="card">
      <h3>ğŸ‘‘ En Ä°yiler</h3>
      1. ShadowBoss - 1200 XP<br>
      2. DarkWolf - 980 XP<br>
      3. KingTR - 870 XP
    </div>
  </div>
  <div class="userpanel" id="userinfo"></div>
</div>

<script>
const SUPABASE_URL="https://hwhscuyudwphnsipibpy.supabase.co";
const SUPABASE_KEY="sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu";
const db=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let userId=localStorage.getItem("tc_user");

const MAX_ENERGY=100;
const MAX_XP=100;
const ENERGY_INTERVAL=5*60*1000;

function openMenu(){
  document.getElementById("sidebar").classList.add("open");
  document.getElementById("overlay").classList.add("show");
}
document.getElementById("overlay").onclick=()=>{
  document.getElementById("sidebar").classList.remove("open");
  document.getElementById("overlay").classList.remove("show");
};

function confirmAge(){
  document.getElementById("nickArea").style.display="block";
}

async function startGame(){
  const nick=document.getElementById("nicknameInput").value.trim();
  if(!nick) return alert("Nickname gir");

  const newId=Date.now().toString();
  userId=newId;

  await db.from("users").insert([{
    id:newId,
    nickname:nick,
    level:1,
    xp:0,
    energy:100,
    yton:10,
    last_energy_tick:Date.now()
  }]);

  localStorage.setItem("tc_user",newId);
  document.getElementById("loginScreen").style.display="none";
  render();
}

async function loadUser(){
  if(!userId) return null;
  const {data}=await db.from("users").select("*").eq("id",userId).maybeSingle();
  return data;
}

async function regenEnergy(user){
  const now=Date.now();
  const diff=now-user.last_energy_tick;
  const add=Math.floor(diff/ENERGY_INTERVAL);

  if(add>0 && user.energy<MAX_ENERGY){
    let newEnergy=Math.min(MAX_ENERGY,user.energy+add);
    let newTick=user.last_energy_tick+(add*ENERGY_INTERVAL);

    await db.from("users").update({
      energy:newEnergy,
      last_energy_tick:newTick
    }).eq("id",userId);

    user.energy=newEnergy;
    user.last_energy_tick=newTick;
  }
  return user;
}

function updateBars(user){
  document.getElementById("xpBar").style.width=(user.xp/MAX_XP*100)+"%";
  document.getElementById("energyBar").style.width=(user.energy/MAX_ENERGY*100)+"%";

  const remaining=ENERGY_INTERVAL-(Date.now()-user.last_energy_tick);

  if(user.energy<MAX_ENERGY){
    const sec=Math.floor(remaining/1000)%60;
    const min=Math.floor(remaining/60000);
    document.getElementById("energyTimer").innerText=
      "Sonraki enerji: "+min+"m "+sec+"s";
  }else{
    document.getElementById("energyTimer").innerText="Enerji Full";
  }
}

async function render(){
  if(!userId){
    document.getElementById("loginScreen").style.display="flex";
    return;
  }

  const user=await loadUser();

  if(!user){
    localStorage.removeItem("tc_user");
    userId=null;
    document.getElementById("loginScreen").style.display="flex";
    return;
  }

  document.getElementById("loginScreen").style.display="none";

  const updated=await regenEnergy(user);

  document.getElementById("stats").innerHTML=
  `Lv ${updated.level} | XP ${updated.xp}/100 | âš¡ ${updated.energy} | ğŸ’° ${Number(updated.yton).toFixed(2)}`;

  updateBars(updated);

  document.getElementById("userinfo").innerHTML=
  `ID: ${updated.id}<br>
   Takma Ad: ${updated.nickname}<br>
   Seviye: ${updated.level}<br>
   Yton: ${updated.yton}`;
}

render();
setInterval(render,1000);
</script>

</body>
</html>
