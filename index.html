<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TonCrime</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:Arial}
.topbar{height:60px;background:#111;display:flex;align-items:center;padding:0 15px}
.logo{color:#f90;font-weight:bold;font-size:18px}
.topstats{margin-left:auto;font-size:13px;text-align:right}
.band{background:#151515;padding:8px 15px;font-size:13px;border-bottom:1px solid #222}
.wrapper{padding:15px}
.card{background:#111;padding:15px;border-radius:12px;margin-bottom:15px}
button{width:100%;padding:10px;background:#f90;border:none;border-radius:8px;font-weight:bold;margin-top:8px;cursor:pointer}
</style>
</head>
<body>

<div class="topbar">
<div class="logo">TonCrime</div>
<div class="topstats" id="topStats"></div>
</div>

<div class="band" id="cityBand">YÃ¼kleniyor...</div>

<div class="wrapper" id="content"></div>

<script>

const supabaseClient = supabase.createClient(
"https://hwhscuyudwphnsipibpy.supabase.co",
"sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

let userId = localStorage.getItem("toncrime_user");

if(!userId){
userId = Math.floor(Math.random()*1000000000);
localStorage.setItem("toncrime_user", userId);
}

init(userId);

async function init(userId){

let now = Math.floor(Date.now()/1000);

let { data } = await supabaseClient
.from("users")
.select("*")
.eq("id", userId)
.maybeSingle();

if(!data){
await supabaseClient.from("users").insert({
id:userId,
nickname:"TestUser",
last_energy_update:now,
last_active:now
});
let res = await supabaseClient.from("users").select("*").eq("id",userId).single();
data = res.data;
}

await supabaseClient.from("users")
.update({ last_active: now })
.eq("id", userId);

data = await handleEnergy(data);
render(data);
updateCityBand();
}

async function handleEnergy(data){

let now = Math.floor(Date.now()/1000);

if(now < data.hospital_until) return data;

if(data.energy < 100){

let diff = now - data.last_energy_update;
let gain = Math.floor(diff / 300);

if(gain > 0){
let newEnergy = Math.min(100, data.energy + gain);

await supabaseClient
.from("users")
.update({
energy:newEnergy,
last_energy_update:now
})
.eq("id", data.id);

data.energy = newEnergy;
}
}
return data;
}

async function render(data){

document.getElementById("topStats").innerHTML =
`Lv ${data.level}<br>XP ${data.xp}/${data.xp_required}<br>âš¡ ${data.energy}/100<br>ğŸ’° ${data.yton}`;

let hospitalBlock = "";
if(Math.floor(Date.now()/1000) < data.hospital_until){
hospitalBlock = `<p style="color:#ff4444">ğŸ¥ Hastanedeysin</p>`;
}

document.getElementById("content").innerHTML = `
<div class="card">
<b>ID:</b> ${data.id}<br>
<b>Takma Ad:</b> ${data.nickname}<br>
<b>Level:</b> ${data.level}<br>
<b>XP:</b> ${data.xp}/${data.xp_required}
</div>

<div class="card">
<b>Enerji:</b> ${data.energy}/100
${hospitalBlock}
</div>
`;
}

async function updateCityBand(){

let now = Math.floor(Date.now()/1000);

let { count } = await supabaseClient
.from("users")
.select("*",{count:"exact",head:true})
.gte("last_active", now-300);

let date = new Date();
let formatted = date.toLocaleDateString("tr-TR",{day:"numeric",month:"long",year:"numeric"});
let time = date.toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});

let status = "Åehir sessiz";
if(count>50) status="Åehir hareketli";
if(count>150) status="Åehir kaynÄ±yor";

document.getElementById("cityBand").innerHTML =
`ğŸ“… ${formatted} | ğŸ•’ ${time} | ğŸ‘¥ ${count} oyuncu aktif | ğŸ”¥ ${status}`;
}

setInterval(updateCityBand,60000);

</script>
</body>
</html>
