<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TonCrime</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  background:#0e0e0e;
  color:white;
  font-family:Arial;
}

/* TOPBAR */
.topbar{
  background:#111;
  padding:18px 40px;
  border-bottom:1px solid #222;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.logo{color:gold;font-size:22px;font-weight:bold}

.right-stats{width:420px}

.bar{
  height:8px;
  background:#333;
  border-radius:5px;
  overflow:hidden;
  margin-bottom:6px;
}

.fill{height:100%}
.xp{background:limegreen}
.energy{background:gold}

/* MENU */
.sidebar{
 position:fixed;
 left:-260px;
 top:0;
 width:250px;
 height:100%;
 background:#151515;
 padding:25px;
 transition:.3s;
}
.sidebar.open{left:0}

.overlay{
 position:fixed;
 width:100%;
 height:100%;
 background:rgba(0,0,0,.6);
 display:none;
}
.overlay.show{display:block}

.main{
 padding:40px;
}
</style>
</head>

<body>

<!-- MENU -->
<div class="sidebar" id="sidebar">
<h3 style="color:gold">MenÃ¼</h3>
<p onclick="go('missions.html')">ðŸŽ¯ GÃ¶revler</p>
<p onclick="go('coffeeshop.html')">â˜• Coffee</p>
<p onclick="go('nightclub.html')">ðŸŽµ Club</p>
<p onclick="go('pvp.html')">âš” PvP</p>
</div>

<div class="overlay" id="overlay"></div>

<!-- TOP -->
<div class="topbar">
<div>
<span style="cursor:pointer" onclick="openMenu()">â˜°</span>
<span class="logo">TonCrime</span>
</div>

<div class="right-stats">
<div id="stats"></div>

<div class="bar">
<div id="xpBar" class="fill xp"></div>
</div>

<div class="bar">
<div id="energyBar" class="fill energy"></div>
</div>

<div id="energyTimer" style="font-size:11px;color:#aaa"></div>
</div>
</div>

<div class="main">
<h2>Ana Sayfa</h2>
<p>Sistem stabil Ã§alÄ±ÅŸÄ±yor.</p>
</div>

<script>
/* ================= CONFIG ================= */

const SUPABASE_URL="https://hwhscuyudwphnsipibpy.supabase.co";
const SUPABASE_KEY="sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu";

const db=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const userId=localStorage.getItem("tc_user") || "591676206";

const MAX_ENERGY=100;
const MAX_XP=100;
const ENERGY_INTERVAL=5*60*1000;

/* ================= MENU ================= */

function openMenu(){
 sidebar.classList.add("open");
 overlay.classList.add("show");
}

overlay.onclick=()=>{
 sidebar.classList.remove("open");
 overlay.classList.remove("show");
}

function go(p){location.href=p}

/* ================= USER ================= */

async function loadUser(){
 const {data}=await db
   .from("users")
   .select("*")
   .eq("id",userId)
   .single();

 return data;
}

/* ================= ENERGY ================= */

async function regenEnergy(user){

 const now=Date.now();

 if(!user.last_energy_tick){
   await db.from("users")
     .update({last_energy_tick:now})
     .eq("id",userId);

   user.last_energy_tick=now;
 }

 const diff=now-user.last_energy_tick;
 const add=Math.floor(diff/ENERGY_INTERVAL);

 if(add>0 && user.energy<MAX_ENERGY){

   const newEnergy=Math.min(MAX_ENERGY,user.energy+add);
   const newTick=user.last_energy_tick+(add*ENERGY_INTERVAL);

   await db.from("users")
     .update({
       energy:newEnergy,
       last_energy_tick:newTick
     })
     .eq("id",userId);

   user.energy=newEnergy;
   user.last_energy_tick=newTick;
 }

 return user;
}

/* ================= UI ================= */

function renderStats(user){

 stats.innerHTML=
 `Lv ${user.level} | XP ${user.xp}/100 | âš¡ ${user.energy} | ðŸ’° ${user.yton}`;

 xpBar.style.width=(user.xp/MAX_XP*100)+"%";
 energyBar.style.width=(user.energy/MAX_ENERGY*100)+"%";

 if(user.energy>=MAX_ENERGY){
   energyTimer.innerText="Enerji Full";
   return;
 }

 const remain=
 ENERGY_INTERVAL-(Date.now()-user.last_energy_tick);

 const min=Math.floor(remain/60000);
 const sec=Math.floor(remain/1000)%60;

 energyTimer.innerText=
 `Sonraki enerji: ${min}m ${sec}s`;
}

/* ================= DAILY RESET ================= */

async function dailyReset(){
 const today=new Date().toDateString();

 if(localStorage.getItem("daily_reset")==today) return;

 localStorage.setItem("daily_reset",today);

 console.log("Daily reset OK");
}

/* ================= PVP REALTIME ================= */

let pvpSubscribed=false;

function subscribePvP(){

 if(pvpSubscribed) return;
 pvpSubscribed=true;

 db.channel('pvp-live')
  .on(
   'postgres_changes',
   {event:'UPDATE',schema:'public',table:'pvp_matches'},
   payload=>{
     console.log("PvP Update:",payload.new);
   }
  )
  .subscribe();
}

/* ================= INIT ================= */

async function init(){

 let user=await loadUser();
 user=await regenEnergy(user);

 renderStats(user);

 await dailyReset();

 subscribePvP();
}

init();

/* ENERGY LOOP */
setInterval(async()=>{
 const user=await loadUser();
 if(!user) return;

 if(user.energy<MAX_ENERGY){
   const u=await regenEnergy(user);
   renderStats(u);
 }
},60000);

/* DAILY CHECK */
setInterval(dailyReset,60000);

</script>
</body>
</html>
